# Unknown Host fallback for Nginx Proxy Manager
server {
	listen 80;
	#listen [::]:80;

	# NPM uses these variables in some includes (e.g. proxy.conf). Defining them
	# here avoids "unknown variable" errors even when no proxy hosts exist yet.
	set $forward_scheme "http";
	set $server "127.0.0.1";
	set $port "80";

	server_name localhost-nginx-proxy-manager;
	access_log /data/logs/fallback_access.log standard;
	error_log /data/logs/fallback_error.log warn;

	include conf.d/include/block-exploits.conf;
	include conf.d/include/letsencrypt-acme-challenge.conf;

	error_page 404 /404.html;
	error_page 500 502 503 504 /503.html;

	# Local convenience routing (when accessing via http://localhost:8090)
	# Forward /auth/* to the auth service directly.
	location = /auth {
		return 301 /auth/;
	}

	location ^~ /auth/ {
		# Auth service enforces ALLOWED_HOSTS; use the configured public host here.
		proxy_set_header Host api.safecare.vn;
		proxy_set_header X-Forwarded-Host api.safecare.vn;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://svc_auth:8000;
	}

	# Forward /sms/* to the sms service directly (strip /sms prefix).
	location = /sms {
		return 301 /sms/;
	}

	location ^~ /sms/ {
		# SMS service enforces ALLOWED_HOSTS; use the configured public host here.
		proxy_set_header Host api.safecare.vn;
		proxy_set_header X-Forwarded-Host api.safecare.vn;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://svc_sms:8000/;
	}

	# Forward /image/* to the image service directly (strip /image prefix).
	location = /image {
		return 301 /image/;
	}

	location ^~ /image/ {
		# Image service enforces ALLOWED_HOSTS; use the configured public host here.
		proxy_set_header Host api.safecare.vn;
		proxy_set_header X-Forwarded-Host api.safecare.vn;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_pass http://svc_image:8000/;
	}

	location = / {
		root /var/www/html;
		try_files /index.html =404;
	}

	location / {
		root /var/www/html;
		try_files $uri $uri/ =404;
	}

	location ~* ^/.*\.(css|js|jpe?g|gif|png|webp|woff2?|eot|ttf|svg|ico)$ {
		root /var/www/html;
		try_files $uri =404;
		access_log off;
		expires 1h;
	}
}

# Keep the default 443 fallback behavior (reject handshake)
server {
	listen 443 ssl;
	#listen [::]:443 ssl;

	server_name localhost;
	access_log /data/logs/fallback_access.log standard;
	error_log /dev/null crit;

	include conf.d/include/ssl-ciphers.conf;
	ssl_reject_handshake on;
	return 444;
}
